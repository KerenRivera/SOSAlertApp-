@model IEnumerable<SOS_Alert_App.Models.Contact>
@{
    ViewData["Title"] = "SOS Alert";
}

<h1 class="text-center text-danger">Alerta de Emergencia</h1>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

@if (!Model.Any())
{
    <p>No hay contactos disponibles. <a href="/Contacts/Create">Agrega uno aqui</a></p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Contact Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var contact in Model)
            {
                <tr>
                    <td>@contact.Name</td>
                    <td>@contact.Email</td>
                    <td>@contact.Phone</td>
                    <td>
                        <form method="post" asp-action="SendAlert" asp-route-contactId="@contact.Id" id="form_@contact.Id">
                            <input type="hidden" name="location" id="location_@contact.Id" />
                            <button type="button" class="btn btn-danger btn-lg" onclick="sendSOSWithLocation(@contact.Id)">
                                Enviar SOS
                            </button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<a href="/Alerts/History" class="btn btn-secondary">Ver historial</a>

<script>
    function sendSOSWithLocation(contactId) {

        const button = document.querySelector(`button[onclick="sendSOSWithLocation(${contactId})"]`);
        const originalText = button.textContent;
        button.textContent = "Getting location...";
        button.disabled = true;

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    // Éxito - obtener coordenadas
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const location = `${lat}, ${lng}`;

                    // Poner la ubicación en el campo hidden
                    document.getElementById(`location_${contactId}`).value = location;

                    // Enviar el formulario
                    document.getElementById(`form_${contactId}`).submit();
                },
                function(error) {
                    // Error o usuario negó el permiso
                    console.log("Geolocation error:", error);

                    // Restaurar botón y enviar sin ubicación
                    button.textContent = originalText;
                    button.disabled = false;

                    document.getElementById(`location_${contactId}`).value = "Ubicación no disponible";
                    document.getElementById(`form_${contactId}`).submit();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        } else {
            // Navegador no soporta geolocalización
            button.textContent = originalText;
            button.disabled = false;

            document.getElementById(`location_${contactId}`).value = "Geolocalización no soportada";
            document.getElementById(`form_${contactId}`).submit();
        }
    }
</script>
